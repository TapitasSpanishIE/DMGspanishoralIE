<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pr√°ctica Oral Leaving Cert - Ordinary Level</title>
  <style>
    :root{
      --bg:#f0f4f8; --card:#fff; --ink:#2c3e50; --muted:#6b7b8c;
      --ok:#1e7e34; --warn:#b7791f; --bad:#b02a37; --blue:#2b6cb0;
      --shadow: 0 2px 8px rgba(0,0,0,.08);
    }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; max-width: 1050px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--ink); }
    h1 { text-align:center; margin: 10px 0 4px; }
    .sub { text-align:center; color: var(--muted); margin-bottom: 18px; }

    .instructions { background: #e8f4fd; padding: 14px 16px; border-radius: 10px; border-left: 6px solid #3498db; box-shadow: var(--shadow); }
    .row { display:flex; gap:14px; flex-wrap:wrap; margin-top: 16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 14px; margin-top: 14px; }
    .topic-card { background: var(--card); padding: 16px; border-radius: 12px; box-shadow: var(--shadow); }
    .topic-card h3 { margin: 0 0 6px; font-size: 17px; }
    .topic-card p { margin: 0; color: var(--muted); font-size: 14px; }
    .pill { display:inline-block; margin-top:8px; font-size:12px; padding:2px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; }

    .controls { background: var(--card); padding: 14px; border-radius: 12px; box-shadow: var(--shadow); flex: 1; min-width: 280px; }
    .controls h2 { margin: 0 0 8px; font-size: 16px; color: var(--blue); }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; }
    button {
      background:#27ae60; color:#fff; border:none; padding:10px 14px; border-radius:10px;
      cursor:pointer; font-weight:700; font-size:15px;
    }
    button.secondary{ background:#4b5563; }
    button.danger{ background:#e74c3c; }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .listening { animation: pulse 1.2s infinite; }
    @keyframes pulse { 0%{ transform: translateY(0); } 50%{ transform: translateY(-1px); } 100%{ transform: translateY(0); } }

    #status { margin-top: 8px; color: var(--muted); min-height: 20px; }
    #questionBox { margin-top: 10px; padding: 10px 12px; border-radius: 10px; background:#f7fafc; border: 1px solid #e5e7eb; }
    #questionBox b { color: var(--ink); }

    #transcriptWrap { background: var(--card); padding: 14px; border-radius: 12px; box-shadow: var(--shadow); margin-top: 14px; }
    #transcriptWrap h2 { margin: 0 0 8px; font-size: 16px; color: var(--blue); display:flex; justify-content:space-between; align-items:center; gap:12px;}
    #transcript { width:100%; min-height: 84px; resize: vertical; padding: 10px; border-radius: 10px; border:1px solid #d1d5db; font-size: 15px; }
    .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }

    #checklist { margin-top: 14px; display:none; }
    .item { display:flex; justify-content:space-between; align-items:center; gap:12px; padding: 10px 12px; border-radius: 10px; background:#f8fafc; border:1px solid #e5e7eb; margin-bottom: 10px; }
    .tag { font-weight:900; padding: 4px 10px; border-radius: 999px; font-size: 12px; }
    .tag.ok { background:#d4edda; color:#155724; }
    .tag.warn { background:#fff3cd; color:#856404; }
    .tag.bad { background:#f8d7da; color:#721c24; }
    .evidence { color: var(--muted); font-size: 13px; margin-top: 2px; }

    #summary { margin-top: 10px; padding: 12px; border-radius: 12px; display:none; }
    #summary.ok { background:#d4edda; color:#155724; }
    #summary.warn { background:#fff3cd; color:#856404; }
    #summary.bad { background:#f8d7da; color:#721c24; }

    .small { font-size: 12px; color: var(--muted); }
    .footer { margin: 18px 0 6px; color: var(--muted); font-size: 12px; text-align:center; }
    code.inline{ background:#eef2ff; padding:2px 6px; border-radius: 8px; }
  </style>
</head>
<body>

  <h1>üá™üá∏ Pr√°ctica Oral: Leaving Cert (OL)</h1>
<div class="authorline">
  <b>Creado por David Mart√≠n Guerrero</b> ‚Äî profesor nativo de espa√±ol (Junior Cycle & Leaving Cert, Irlanda).<br/>
  <b>Created by David Mart√≠n Guerrero</b> ‚Äî native Spanish teacher (Junior Cycle & Leaving Cert, Ireland).
</div>
  <div class="sub">Habla, transcribe y comprueba si has cubierto los puntos clave.</div>

  <div class="instructions">
    <b>Instrucciones:</b> Selecciona un tema ‚Üí pulsa <code class="inline">Empezar</code> ‚Üí responde en voz alta.
    Revisa la transcripci√≥n (puedes corregirla) y pulsa <code class="inline">Analizar</code>.
    <div class="small" style="margin-top:6px;">
      Nota: si el micr√≥fono no funciona en tu dispositivo, pega aqu√≠ tu respuesta escrita y analiza igualmente.
    </div>
  </div>

  <div class="row">
    <div class="controls">
      <h2>Controles</h2>
      <div class="btnrow">
        <button id="btnStart" onclick="startFlow()" disabled>‚ñ∂Ô∏è Empezar</button>
        <button class="secondary" id="btnStop" onclick="stopListening()" disabled>‚èπÔ∏è Parar</button>
        <button class="secondary" id="btnAnalyze" onclick="analyzeNow()" disabled>üß† Analizar</button>
        <button class="danger" id="btnReset" onclick="resetAll()">üîÑ Reset</button>
      </div>

      <div id="status">Elige un tema para activar ‚ÄúEmpezar‚Äù.</div>

      <div id="questionBox">
        <b>Tema:</b> <span id="topicName">‚Äî</span><br/>
        <b>Prompt (ES):</b> <span id="topicQuestionES">‚Äî</span><br/>
        <b>Prompt (EN):</b> <span id="topicQuestionEN">‚Äî</span>
      </div>

      <div class="hint">
        Truco: usa conectores simples (<b>tambi√©n</b>, <b>porque</b>, <b>normalmente</b>) y frases claras.
      </div>
    </div>

    <div class="controls" style="flex:1.35;">
      <h2>Temas</h2>
      <div class="grid" id="topicsGrid"></div>
    </div>
  </div>

  <div id="transcriptWrap">
    <h2>
      <span>Transcripci√≥n</span>
      <span class="small">Puedes editarla antes de analizar</span>
    </h2>
    <textarea id="transcript" placeholder="Tu respuesta aparecer√° aqu√≠ (o pega aqu√≠ un texto si no funciona el micr√≥fono)..."></textarea>
    <div class="hint">El an√°lisis se basa en este texto. Si la transcripci√≥n sale rara, corr√≠gela un poco.</div>

    <div id="summary"></div>
    <div id="checklist"></div>
  </div>

  <div class="footer">Versi√≥n ‚Äúchecklist‚Äù para pr√°ctica: marca ideas clave (no es una nota oficial).</div>

<script>
/* =========================
   CONFIGURACI√ìN (PROFE)
   ========================= */
const MONTHS = /(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|setiembre|octubre|noviembre|diciembre)/u;

const FAMILY_VOCAB = [
  "madre","padre","mam√°","mama","pap√°","papa",
  "hermano","hermana","abuelo","abuela","tio","t√≠a","tia","primo","prima",
  "hijo","hija","sobrino","sobrina","padrastro","madrastra"
];

const PHYSICAL_WORDS = [
  "alto","alta","bajo","baja","delgado","delgada","gordito","gordita","gordo","gorda"
];

const HAIR_WORDS = [
  "pelo","cabello","largo","corto","rizado","liso","ondulado",
  "casta√±o","castano","rubio","rubia","moreno","morena","negro","negra","pelirrojo","pelirroja"
];

const EYES_WORDS = [
  "ojos","azules","verdes","marrones","negros"
];

const PERSONALITY_ADJ = [
  "simpatico","simp√°tica","amable","divertido","divertida",
  "serio","seria","trabajador","trabajadora","inteligente","t√≠mido","timido","t√≠mida","timida",
  "generoso","generosa","agradable","responsable","perezoso","perezosa","hablador","habladora",
  "cari√±oso","carinoso","cari√±osa","carinosa"
];

const HOBBIES = [
  "leer","escuchar musica","musica","bailar","cantar","dibujar",
  "jugar","videojuegos","futbol","baloncesto","padel","natacion",
  "correr","caminar","ir de compras","compras","ver series","ver peliculas","cine",
  "cocinar","viajar","tocar la guitarra","guitarra"
];

const TOWN_FACILITIES = [
  "parque","polideportivo","piscina","cine","centro comercial","supermercado","tiendas",
  "biblioteca","estacion","estaci√≥n","hospital","farmacia","colegio","instituto",
  "restaurantes","cafeterias","cafeter√≠as","playa"
];

const SCHOOL_FACILITIES = [
  "gimnasio","biblioteca","laboratorio","cantina","cafeteria","cafeter√≠a",
  "pistas","campo","aula de informatica","aula de inform√°tica","sala de ordenadores",
  "comedor","patio","sala de musica","sala de m√∫sica"
];

const TOPICS = {
  about_me: {
    code: "1A",
    title: "H√°blame de ti",
    question_es: "H√°blame de ti. Sigue este orden: 1) Me llamo‚Ä¶ 2) Tengo ‚Ä¶ a√±os. 3) Mi cumplea√±os es el ‚Ä¶ de ‚Ä¶ 4) Normalmente lo celebro con‚Ä¶ (familia/amigos) 5) Soy de‚Ä¶ / Vivo en‚Ä¶",
    question_en: "Talk about yourself. Follow this order: 1) My name is‚Ä¶ 2) I am ‚Ä¶ years old. 3) My birthday is on‚Ä¶ 4) I usually celebrate it with‚Ä¶ 5) I‚Äôm from‚Ä¶ / I live in‚Ä¶",
    speak: "Habla de ti.",
    criteria: [
      { id:"nombre", label:"Nombre", required:true,
        patterns:[/me llamo\s+\p{L}+/u, /mi nombre es\s+\p{L}+/u, /soy\s+\p{L}+/u],
        hint:"Di tu nombre. Ej.: ¬´Me llamo Laura.¬ª" },
      { id:"edad", label:"Edad", required:true,
        patterns:[/tengo\s+\d+\s+anos?/u, /tengo\s+\p{L}+\s+anos?/u, "tengo","a√±os","anos"],
        hint:"Di tu edad. Ej.: ¬´Tengo quince a√±os.¬ª" },
      { id:"fecha_cumple", label:"Fecha de cumplea√±os (d√≠a/mes)", required:true,
        patterns:["mi cumplea√±os es","mi cumple es","cumplo a√±os","cumplo anos","nac√≠ el","naci el", MONTHS, /\b(el|el dia)\s+\d{1,2}\b/u],
        hint:"Di la fecha/mes. Ej.: ¬´Mi cumplea√±os es el 3 de mayo.¬ª" },
      { id:"celebracion", label:"C√≥mo celebras el cumplea√±os", required:true,
        patterns:["lo celebro","celebramos","hago una fiesta","tengo una fiesta","salgo","vamos a","voy a","cena","comemos","con mi familia","con mis amigos"],
        hint:"Di c√≥mo lo celebras. Ej.: ¬´Normalmente lo celebro con mi familia.¬ª" },
      { id:"origen", label:"De d√≥nde eres", required:true,
        patterns:[/soy de\s+\p{L}+/u, /vivo en\s+\p{L}+/u, /naci en\s+\p{L}+/u, "irlanda","dublin","dubl√≠n","balbriggan"],
        hint:"Di de d√≥nde eres. Ej.: ¬´Soy de Irlanda / Vivo en Dubl√≠n.¬ª" }
    ]
  },

  physical: {
    code: "1B",
    title: "¬øC√≥mo eres f√≠sicamente?",
    question_es: "Descr√≠bete f√≠sicamente. Usa: ¬´Soy‚Ä¶¬ª y ¬´Tengo‚Ä¶¬ª. Di: 1) Soy alto/a o bajo/a. 2) Soy delgado/a o gordito/a. 3) Tengo el pelo‚Ä¶ (color + largo/corto). 4) Tengo los ojos‚Ä¶",
    question_en: "Describe your appearance. Use: ‚ÄúSoy‚Ä¶‚Äù and ‚ÄúTengo‚Ä¶‚Äù. Say: 1) Tall/short. 2) Slim/chubby. 3) Hair (colour + long/short). 4) Eyes colour.",
    speak: "Describe c√≥mo eres f√≠sicamente.",
    criteria: [
      { id:"altura", label:"Alto o bajo", required:true,
        patterns:["soy alto","soy alta","soy bajo","soy baja","alto","bajo"],
        hint:"Di si eres alto o bajo. Ej.: ¬´Soy alto.¬ª" },
      { id:"constitucion", label:"Delgado o gordito", required:true,
        patterns:["delgado","delgada","gordito","gordita","gordo","gorda"],
        hint:"Di si eres delgado o gordito. Ej.: ¬´Soy delgado / Soy gordito.¬ª" },
      { id:"pelo", label:"Pelo (color y/o tipo)", required:true,
        patterns:[/tengo el pelo\s+\p{L}+/u, "tengo pelo", ...HAIR_WORDS],
        hint:"Describe tu pelo. Ej.: ¬´Tengo el pelo casta√±o y corto.¬ª" },
      { id:"ojos", label:"Ojos (color)", required:true,
        patterns:[/tengo (los )?ojos\s+\p{L}+/u, ...EYES_WORDS],
        hint:"Describe tus ojos. Ej.: ¬´Tengo los ojos verdes.¬ª" }
    ]
  },

  personality: {
    code: "1C",
    title: "¬øC√≥mo eres de personalidad?",
    question_es: "Describe tu personalidad con ¬´soy¬ª. Di 2‚Äì3 adjetivos y, si puedes, a√±ade una raz√≥n con ¬´porque¬ª. Ej.: ¬´Soy simp√°tico y trabajador porque‚Ä¶¬ª",
    question_en: "Describe your personality using ‚Äúsoy‚Äù. Say 2‚Äì3 adjectives and, if possible, add a reason with ‚Äúbecause‚Äù.",
    speak: "Describe tu personalidad.",
    criteria: [
      { id:"soy_personalidad", label:"Adjetivos de personalidad con ¬´soy¬ª", required:true,
        patterns:[/soy\s+\p{L}+/u, ...PERSONALITY_ADJ],
        hint:"Usa ¬´soy¬ª + adjetivo. Ej.: ¬´Soy simp√°tico y amable.¬ª" }
    ]
  },

  family: {
    code: "2A",
    title: "La familia",
    question_es: "Habla de tu familia. Sigue este orden: 1) En mi familia somos‚Ä¶ 2) Tengo‚Ä¶ (madre/padre/hermanos‚Ä¶) 3) Mi ‚Ä¶ se llama‚Ä¶ 4) Es‚Ä¶ (f√≠sico / personalidad / profesi√≥n) 5) Me llevo bien/mal con‚Ä¶",
    question_en: "Talk about your family. Follow this order: 1) There are ‚Ä¶ people. 2) I have‚Ä¶ (mother/father/siblings‚Ä¶) 3) My ‚Ä¶ is called‚Ä¶ 4) He/She is‚Ä¶ (appearance/personality/job) 5) I get on well/badly with‚Ä¶",
    speak: "Habla de tu familia.",
    criteria: [
      { id:"miembros", label:"Cu√°ntos miembros hay", required:true,
        patterns:[/somos\s+\d+/u, /hay\s+\d+/u, "en mi familia somos","miembros","personas"],
        hint:"Di cu√°ntos sois. Ej.: ¬´En mi familia somos cinco.¬ª" },
      { id:"quienes", label:"Qui√©nes son (vocabulario de familia)", required:true,
        patterns:[...FAMILY_VOCAB],
        hint:"Menciona familiares (madre, padre, hermano‚Ä¶)."},
      { id:"nombres", label:"Nombre de alguien (se llama...)", required:true,
        patterns:[/se llama\s+\p{L}+/u, "se llama","mi madre se llama","mi padre se llama"],
        hint:"Di el nombre de alguien. Ej.: ¬´Mi madre se llama Ana.¬ª" },
      { id:"descripcion", label:"Breve descripci√≥n (f√≠sico / personalidad / profesi√≥n)", required:true,
        patterns:[
          "es alto","es alta","es bajo","es baja","tiene el pelo","tiene los ojos", ...PHYSICAL_WORDS, ...HAIR_WORDS, ...EYES_WORDS,
          "es simpatico","es simpatica","amable","divertido","divertida","serio","seria","trabajador","trabajadora","inteligente",
          "trabaja","es profesor","es profesora","es medico","es medica","es enfermero","es enfermera","es camarero","es camarera",
          "es policia","es polic√≠a","es abogado","es abogada","es ingeniero","es ingeniera","es funcionario","es estudiante"
        ],
        hint:"Describe a alguien (f√≠sico, personalidad o profesi√≥n). Ej.: ¬´Mi hermano es divertido¬ª o ¬´Mi padre es m√©dico¬ª." },
      { id:"relacion", label:"Relaci√≥n: me llevo bien/mal con alguien", required:true,
        patterns:[/me llevo bien con\s+\p{L}+/u, /me llevo mal con\s+\p{L}+/u, "me llevo bien con mi","me llevo mal con mi"],
        hint:"Di con qui√©n te llevas bien o mal. Ej.: ¬´Me llevo bien con mi hermano.¬ª" }
    ]
  },

  best_friend: {
    code: "3A",
    title: "Mi mejor amigo/a",
    question_es: "Habla de tu mejor amigo/a. Di: 1) Se llama‚Ä¶ 2) Nos conocemos desde‚Ä¶ / Nos conocimos en‚Ä¶ 3) Es‚Ä¶ / Tiene‚Ä¶ (descripci√≥n) 4) Le gusta‚Ä¶ (afici√≥n) 5) Es mi mejor amigo/a porque‚Ä¶",
    question_en: "Talk about your best friend. Say: 1) Name. 2) Since when/how you met. 3) Description. 4) Hobby. 5) Why they are your best friend.",
    speak: "Habla de tu mejor amigo.",
    criteria: [
      { id:"nombre", label:"Nombre", required:true,
        patterns:[/se llama\s+\p{L}+/u, "mi mejor amigo se llama","mi mejor amiga se llama"],
        hint:"Di su nombre. Ej.: ¬´Mi mejor amigo se llama Daniel.¬ª" },
      { id:"desde_cuando", label:"C√≥mo/se conocen desde cu√°ndo", required:true,
        patterns:["nos conocemos desde","lo conozco desde","la conozco desde","desde hace","nos conocimos","en primaria","en el colegio","en el instituto"],
        hint:"Di desde cu√°ndo o c√≥mo os conocisteis. Ej.: ¬´Nos conocemos desde primaria.¬ª" },
      { id:"descripcion", label:"Descripci√≥n breve (f√≠sico o personalidad)", required:true,
        patterns:["tiene el pelo","tiene los ojos","es alto","es alta","es bajo","es baja","es simpatico","es simpatica","amable","divertido","divertida","serio","seria","inteligente", ...PHYSICAL_WORDS, ...HAIR_WORDS, ...EYES_WORDS],
        hint:"Descr√≠belo/a. Ej.: ¬´Es simp√°tico y tiene el pelo corto.¬ª" },
      { id:"aficion", label:"Algo que le gusta hacer (afici√≥n)", required:true,
        patterns:["le gusta","le encanta","le gusta hacer","le encanta hacer", ...HOBBIES],
        hint:"Di una afici√≥n. Ej.: ¬´Le gusta jugar al f√∫tbol.¬ª" }
    ]
  },

  house: {
    code: "4A",
    title: "Mi casa",
    question_es: "Describe tu casa. Di: 1) Vivo en‚Ä¶ (casa/piso). 2) Tiene ‚Ä¶ plantas. 3) Hay‚Ä¶ (habitaciones). 4) Mi habitaci√≥n favorita es‚Ä¶ porque‚Ä¶",
    question_en: "Describe your home. Say: 1) I live in a house/flat. 2) It has ‚Ä¶ floors. 3) There is/are‚Ä¶ (rooms). 4) My favourite room is‚Ä¶ because‚Ä¶",
    speak: "Habla de tu casa.",
    criteria: [
      { id:"tipo", label:"Tipo de casa", required:true,
        patterns:["vivo en un piso","vivo en una casa","piso","apartamento","casa","casa adosada","chalet"],
        hint:"Di el tipo de casa. Ej.: ¬´Vivo en una casa / en un piso.¬ª" },
      { id:"plantas", label:"N√∫mero de plantas", required:true,
        patterns:["una planta","dos plantas","tres plantas", /tiene\s+\d+\s+plantas?/u, /hay\s+\d+\s+plantas?/u],
        hint:"Di cu√°ntas plantas tiene. Ej.: ¬´Tiene dos plantas.¬ª" },
      { id:"habitaciones", label:"Habitaciones", required:true,
        patterns:["habitaciones","dormitorios","salon","sal√≥n","cocina","ba√±o","bano","jardin","jard√≠n","garaje"],
        hint:"Menciona habitaciones. Ej.: ¬´Hay cocina, sal√≥n y tres dormitorios.¬ª" },
      { id:"favorita", label:"Habitaci√≥n favorita", required:true,
        patterns:["mi habitaci√≥n favorita es","mi habitacion favorita es","mi cuarto favorito es","mi favorita es","mi lugar favorito es"],
        hint:"Di tu habitaci√≥n favorita. Ej.: ¬´Mi habitaci√≥n favorita es el sal√≥n.¬ª" }
    ]
  },

  bedroom: {
    code: "4B",
    title: "Mi dormitorio",
    question_es: "Habla de tu dormitorio. Di: 1) Me gusta / No me gusta mi dormitorio. 2) Porque‚Ä¶ (es grande/peque√±o, c√≥modo, bonito, etc.). 3) Hay‚Ä¶ (cama, escritorio‚Ä¶).",
    question_en: "Talk about your bedroom. Say: 1) I like/don‚Äôt like it. 2) Because‚Ä¶ (big/small, comfortable, nice‚Ä¶). 3) There is/are‚Ä¶ (bed, desk‚Ä¶).",
    speak: "Habla de tu dormitorio.",
    criteria: [
      { id:"gusta", label:"Si te gusta (o no)", required:true,
        patterns:["me gusta mi dormitorio","me gusta mi habitaci√≥n","me encanta mi habitaci√≥n","no me gusta mi habitaci√≥n","no me gusta mi dormitorio"],
        hint:"Di si te gusta o no. Ej.: ¬´Me gusta mi dormitorio.¬ª" },
      { id:"por_que", label:"Por qu√© (raz√≥n)", required:true,
        patterns:["porque","ya que","es grande","es peque√±o","es pequeno","es c√≥modo","es comodo","es bonito","tengo","hay","mi cama","mi escritorio","ordenado","desordenado"],
        hint:"Da una raz√≥n con ¬´porque¬ª. Ej.: ¬´Me gusta porque es c√≥modo.¬ª" }
    ]
  },

  area: {
    code: "5A",
    title: "Mi barrio / mi pueblo",
    question_es: "Habla de tu barrio/pueblo. Di: 1) Vivo en‚Ä¶ 2) Est√° en el centro / en las afueras. 3) Hay‚Ä¶ (parque, cine, supermercado‚Ä¶). 4) Me gusta porque‚Ä¶",
    question_en: "Talk about your area/town. Say: 1) I live in‚Ä¶ 2) In the centre/outskirts. 3) There is/are‚Ä¶ (park, cinema, shops‚Ä¶). 4) I like it because‚Ä¶",
    speak: "Habla de tu barrio o pueblo.",
    criteria: [
      { id:"donde", label:"D√≥nde vives", required:true,
        patterns:[/vivo en\s+\p{L}+/u, "vivo en","en mi barrio","en mi pueblo","en mi ciudad"],
        hint:"Di d√≥nde vives. Ej.: ¬´Vivo en Balbriggan.¬ª" },
      { id:"centro_afueras", label:"Centro o afueras", required:true,
        patterns:["en el centro","en las afueras","cerca del centro","lejos del centro"],
        hint:"Di si vives en el centro o en las afueras." },
      { id:"instalaciones", label:"Instalaciones (hay...)", required:true,
        patterns:["hay", ...TOWN_FACILITIES],
        hint:"Menciona instalaciones. Ej.: ¬´Hay un parque y un cine.¬ª" }
    ]
  },

  school_general: {
    code: "6A",
    title: "Mi instituto",
    question_es: "Habla de tu instituto. Di: 1) Es grande/peque√±o y moderno/antiguo. 2) Es mixto / de chicos / de chicas. 3) Hay‚Ä¶ (instalaciones). 4) Me gusta porque‚Ä¶",
    question_en: "Talk about your school. Say: 1) Big/small and modern/old. 2) Mixed/boys/girls. 3) There is/are‚Ä¶ (facilities). 4) I like it because‚Ä¶",
    speak: "Habla de tu instituto.",
    criteria: [
      { id:"tamano", label:"Grande o peque√±o", required:true,
        patterns:["es grande","es peque√±o","es pequeno","grande","peque√±o","pequeno"],
        hint:"Di si es grande o peque√±o. Ej.: ¬´Mi instituto es grande.¬ª" },
      { id:"moderno", label:"Moderno (o antiguo)", required:true,
        patterns:["es moderno","es nuevo","es antiguo","es viejo","moderno","antiguo","viejo"],
        hint:"Di si es moderno o antiguo. Ej.: ¬´Es moderno.¬ª" },
      { id:"tipo", label:"Mixto / chicos / chicas", required:true,
        patterns:["mixto","es mixto","solo chicos","solo chicas","es de chicos","es de chicas"],
        hint:"Di si es mixto o solo de chicos/chicas." },
      { id:"instalaciones", label:"Instalaciones del instituto", required:true,
        patterns:["hay", ...SCHOOL_FACILITIES],
        hint:"Menciona instalaciones. Ej.: ¬´Hay gimnasio y biblioteca.¬ª" }
    ]
  },

  school_rules: {
    code: "6B",
    title: "Normas en mi instituto",
    question_es: "Habla de las normas. Di: 1) En mi instituto se puede / no se puede usar el m√≥vil‚Ä¶ 2) Est√° prohibido / se puede mascar chicle‚Ä¶",
    question_en: "Talk about school rules. Say: 1) You can/can‚Äôt use your phone‚Ä¶ 2) Chewing gum is allowed/forbidden‚Ä¶",
    speak: "Habla de las normas del instituto.",
    criteria: [
      { id:"moviles", label:"Uso de m√≥viles", required:true,
        patterns:["telefono movil","tel√©fono m√≥vil","movil","m√≥vil","se puede usar","no se puede usar","esta prohibido","est√° prohibido","prohibido","en clase","en el patio"],
        hint:"Di si se pueden usar m√≥viles. Ej.: ¬´No se puede usar el m√≥vil en clase.¬ª" },
      { id:"chicle", label:"Chicle", required:true,
        patterns:["chicle","comer chicle","mascar chicle","se puede comer chicle","no se puede comer chicle","prohibido chicle"],
        hint:"Di si se puede comer/mascar chicle. Ej.: ¬´Est√° prohibido comer chicle.¬ª" }
    ]
  },

  teachers: {
    code: "6C",
    title: "¬øC√≥mo son los profesores?",
    question_es: "Habla de los profesores. Di: 1) Son estrictos/amables‚Ä¶ 2) Mi profesor/a favorito/a es‚Ä¶ 3) Porque‚Ä¶ (explica bien, me ayuda, es paciente‚Ä¶).",
    question_en: "Talk about teachers. Say: 1) They are strict/kind‚Ä¶ 2) My favourite teacher is‚Ä¶ 3) Because‚Ä¶ (explains well, helps me, patient‚Ä¶).",
    speak: "Habla de los profesores.",
    criteria: [
      { id:"estrictos_amables", label:"Estrictos o amables", required:true,
        patterns:["estricto","estricta","estrictos","estrictas","amable","amables","simpatico","simpatica","bueno","buena"],
        hint:"Di c√≥mo son. Ej.: ¬´Los profesores son amables, pero algunos son estrictos.¬ª" },
      { id:"favorito", label:"Profesor/a favorito/a", required:true,
        patterns:["mi profesor favorito es","mi profesora favorita es","mi profe favorito es","mi profe favorita es"],
        hint:"Di qui√©n es tu favorito/a. Ej.: ¬´Mi profesor favorito es el de espa√±ol.¬ª" },
      { id:"por_que", label:"Por qu√© (raz√≥n)", required:true,
        patterns:["porque","ya que","explica bien","me ayuda","es divertido","es paciente","es comprensivo","es comprensiva"],
        hint:"Da una raz√≥n. Ej.: ¬´Porque explica muy bien y me ayuda.¬ª" }
    ]
  },


  uniform: {
    code: "6D",
    title: "El uniforme",
    question_es: "Habla del uniforme. Di: 1) Hay que llevar uniforme / Es obligatorio. 2) Consiste en‚Ä¶ (jersey, camisa, pantal√≥n o falda, zapatos; corbata opcional).",
    question_en: "Talk about the uniform. Say: 1) It is compulsory. 2) It includes‚Ä¶ (jumper, shirt, trousers or skirt, shoes; tie optional).",
    speak: "Habla del uniforme.",
    criteria: [
      { id:"obligatorio", label:"Hay que llevar uniforme", required:true,
        patterns:["hay que llevar uniforme","llevo uniforme","llevamos uniforme","es obligatorio","uniforme obligatorio","tenemos uniforme"],
        hint:"Di si hay que llevar uniforme. Ej.: ¬´Hay que llevar uniforme.¬ª" },
      { id:"prendas", label:"En qu√© consiste (jersey, pantal√≥n/falda, zapatos, camisa)", required:true,
        patterns:["jersey","sudadera","pantalon","pantal√≥n","pantalones","falda","zapatos","camisa","corbata"],
        hint:"Describe el uniforme. Ej.: ¬´Llevo jersey, camisa y pantal√≥n/falda. Normalmente llevo zapatos.¬ª" }
    ]
  },

  free_time: {
    code: "7A",
    title: "Mi tiempo libre",
    question_es: "Habla de tu tiempo libre. Di 2‚Äì3 aficiones usando: ¬´En mi tiempo libre‚Ä¶¬ª, ¬´Me gusta‚Ä¶¬ª, ¬´Me encanta‚Ä¶¬ª. Ej.: ¬´Me gusta jugar al f√∫tbol y escuchar m√∫sica¬ª.",
    question_en: "Talk about your free time. Say 2‚Äì3 hobbies using: ‚ÄúIn my free time‚Ä¶‚Äù, ‚ÄúI like‚Ä¶‚Äù, ‚ÄúI love‚Ä¶‚Äù.",
    speak: "Habla de tu tiempo libre.",
    criteria: [
      { id:"aficiones", label:"Aficiones", required:true,
        patterns:["en mi tiempo libre","me gusta","me encanta","suelo", ...HOBBIES],
        hint:"Menciona al menos una afici√≥n. Ej.: ¬´En mi tiempo libre me gusta jugar a los videojuegos.¬ª" }
    ]
  },

  weekends: {
    code: "7B",
    title: "Los fines de semana",
    question_es: "Habla de los fines de semana (rutina). Usa: ¬´Los fines de semana normalmente/suelo‚Ä¶¬ª. Di 2‚Äì3 cosas que haces (por la ma√±ana / por la tarde).",
    question_en: "Talk about weekends (routine). Use: ‚ÄúAt weekends I usually‚Ä¶‚Äù. Say 2‚Äì3 things you do (morning/afternoon).",
    speak: "Habla de los fines de semana.",
    criteria: [
      { id:"rutina", label:"Qu√© haces los fines de semana", required:true,
        patterns:["los fines de semana","normalmente","suelo","a veces","siempre","casi siempre","nunca","por la ma√±ana","por la tarde","por la noche","quedo con","salgo con","voy al","voy a la","voy a"],
        hint:"Di qu√© haces normalmente. Ej.: ¬´Los fines de semana suelo quedar con mis amigos.¬ª" }
    ]
  },

  last_weekend: {
    code: "8A",
    title: "El fin de semana pasado",
    question_es: "Habla del fin de semana pasado (pasado). Usa 2‚Äì3 frases con: ¬´Fui‚Ä¶¬ª, ¬´Hice‚Ä¶¬ª, ¬´Estudi√©‚Ä¶¬ª, ¬´Sal√≠‚Ä¶¬ª. Ej.: ¬´El fin de semana pasado fui al cine¬ª.",
    question_en: "Talk about last weekend (past). Use 2‚Äì3 past sentences: ‚ÄúI went‚Ä¶‚Äù, ‚ÄúI did‚Ä¶‚Äù, ‚ÄúI studied‚Ä¶‚Äù, ‚ÄúI went out‚Ä¶‚Äù.",
    speak: "Habla del fin de semana pasado.",
    criteria: [
      { id:"pasado", label:"Acciones en pasado (fui/estudi√©/sal√≠...)", required:true,
        patterns:["el fin de semana pasado","ayer","fui","estudie","estudi√©","sali","sal√≠","jugu√©","jugue","vi","hice","comi","com√≠","fui al cine","fui a la playa","fui al centro comercial","estudi√© para","estudie para"],
        hint:"Usa el pasado. Ej.: ¬´El fin de semana pasado fui al cine y estudi√© para los ex√°menes.¬ª" }
    ]
  },

  next_weekend: {
    code: "9A",
    title: "El fin de semana que viene",
    question_es: "Habla del fin de semana que viene (futuro). Usa: ¬´Este fin de semana voy a‚Ä¶¬ª. Di 2‚Äì3 planes. Ej.: ¬´Voy a ir a la playa¬ª o ¬´Voy a estudiar¬ª.",
    question_en: "Talk about next weekend (future). Use: ‚ÄúThis weekend I‚Äôm going to‚Ä¶‚Äù. Say 2‚Äì3 plans.",
    speak: "Habla del fin de semana que viene.",
    criteria: [
      { id:"planes", label:"Planes en futuro (voy a...)", required:true,
        patterns:["este fin de semana","el fin de semana que viene","tengo planes","planes","voy a","pienso","quiero"],
        hint:"Habla en futuro. Ej.: ¬´Este fin de semana voy a ir al cine.¬ª" }
    ]
  },

  future_plans: {
    code: "10A",
    title: "Proyectos de futuro",
    question_es: "Proyectos de futuro. Di: 1) Despu√©s de los ex√°menes voy a‚Ä¶ 2) El a√±o que viene me gustar√≠a‚Ä¶ 3) Porque‚Ä¶ (si puedes).",
    question_en: "Future plans. Say: 1) After the exams I‚Äôm going to‚Ä¶ 2) Next year I would like to‚Ä¶ 3) Because‚Ä¶ (if you can).",
    speak: "Habla de tus proyectos de futuro.",
    criteria: [
      { id:"despues_examenes", label:"Despu√©s de los ex√°menes (voy a...)", required:true,
        patterns:[
          "despues de los examenes","despu√©s de los ex√°menes","cuando termine los examenes","cuando termine los ex√°menes",
          "voy a","pienso","quiero"
        ],
        hint:"Di qu√© vas a hacer despu√©s de los ex√°menes usando ¬´voy a¬ª. Ej.: ¬´Despu√©s de los ex√°menes voy a salir con mis amigos.¬ª" },
      { id:"ano_que_viene", label:"El a√±o que viene (me gustar√≠a...)", required:true,
        patterns:[
          "el ano que viene","el a√±o que viene","el proximo ano","el pr√≥ximo a√±o",
          "me gustaria","me gustar√≠a","quiero","pienso"
        ],
        hint:"Di qu√© te gustar√≠a hacer el a√±o que viene. Ej.: ¬´El a√±o que viene me gustar√≠a ir a Espa√±a.¬ª" }
    ]
  },

  spain_holidays: {
    code: "11A",
    title: "Vacaciones en Espa√±a",
    question_es: "Vacaciones en Espa√±a. Di: 1) He estado / Nunca he estado en Espa√±a. 2) Fui a‚Ä¶ (ciudad). 3) Me gust√≥ / No me gust√≥ porque‚Ä¶ 4) La comida espa√±ola es‚Ä¶ (me encanta/no me gusta).",
    question_en: "Holidays in Spain. Say: 1) I have / have never been to Spain. 2) I went to‚Ä¶ (city). 3) I liked/didn‚Äôt like it because‚Ä¶ 4) Spanish food is‚Ä¶ (I love/don‚Äôt like it).",
    speak: "Habla de tus vacaciones en Espa√±a.",
    criteria: [
      { id:"ha_estado", label:"Has estado en Espa√±a (s√≠/no)", required:true,
        patterns:[
          "he estado en espana","he estado en espa√±a","he ido a espana","he ido a espa√±a","estuve en espana","estuve en espa√±a",
          "nunca he estado","no he estado nunca","no he ido nunca","no he estado en espana","no he estado en espa√±a"
        ],
        hint:"Di si has estado en Espa√±a o no. Ej.: ¬´He estado en Espa√±a.¬ª / ¬´Nunca he estado en Espa√±a.¬ª" },
      { id:"ciudad", label:"Ciudad (fui a / estuve en...)", required:true,
        patterns:[
          "fui a","estuve en","visite","visit√©","madrid","barcelona","valencia","sevilla","malaga","m√°laga","granada","bilbao","cadiz","c√°diz"
        ],
        hint:"Di una ciudad. Ej.: ¬´Fui a Barcelona.¬ª" },
      { id:"te_gusto", label:"Te gust√≥ (me gust√≥ porque...)", required:true,
        patterns:[
          "me gusto","me gust√≥","me encanto","me encant√≥","no me gusto","no me gust√≥","me gusto porque","me gust√≥ porque","porque"
        ],
        hint:"Di si te gust√≥ y da una raz√≥n con ¬´porque¬ª. Ej.: ¬´Me gust√≥ porque hac√≠a buen tiempo.¬ª" },
      { id:"comida", label:"Opini√≥n sobre la comida espa√±ola", required:true,
        patterns:[
          "la comida","comida espanola","comida espa√±ola","me encanta la comida","me gusta la comida","no me gusta la comida",
          "deliciosa","rica","sabrosa","picante","variada","tapas","paella","tortilla","jamon","jam√≥n","gazpacho"
        ],
        hint:"Da tu opini√≥n sobre la comida. Ej.: ¬´La comida espa√±ola es deliciosa. Me encantan las tapas.¬ª" }
    ]
  },



  };

/* =========================
   UI: pintar tarjetas
   ========================= */
const topicsGrid = document.getElementById("topicsGrid");
let currentKey = null;

function renderTopics(){
  topicsGrid.innerHTML = "";
  Object.entries(TOPICS).forEach(([key, t]) => {
    const div = document.createElement("div");
    div.className = "topic-card";
    const reqCount = t.criteria.filter(c=>c.required).length;
    const optCount = t.criteria.filter(c=>!c.required).length;
    div.innerHTML = `
      <h3>${t.title}</h3>
      <p><small>${reqCount} puntos obligatorios${optCount ? ` + ${optCount} extra` : ""}</small></p>
      <span class="pill">${t.code}</span>
      <div style="margin-top:10px;">
        <button onclick="selectTopic('${key}')">Seleccionar</button>
      </div>
    `;
    topicsGrid.appendChild(div);
  });
}
renderTopics();

function selectTopic(key){
  currentKey = key;
  const t = TOPICS[key];
  document.getElementById("topicName").textContent = `${t.code} ‚Äî ${t.title}`;
  document.getElementById("topicQuestionES").textContent = t.question_es || t.question || "‚Äî";
  document.getElementById("topicQuestionEN").textContent = t.question_en || "‚Äî";
  setStatus("Tema seleccionado. Pulsa ¬´Empezar¬ª para escuchar y responder.");
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnAnalyze").disabled = false;
  hideResults();

}

/* ==========================
   Speech: s√≠ntesis + reconocimiento
   ========================= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isListening = false;

function canRecognize(){ return !!SpeechRecognition; }

function buildRecognition(){
  const r = new SpeechRecognition();
  r.lang = "es-ES";
  r.continuous = false;
  r.interimResults = false;
  r.maxAlternatives = 1;

  r.onresult = (event) => {
    const transcript = event.results[0][0].transcript || "";
    document.getElementById("transcript").value = transcript;
    setStatus("Transcripci√≥n lista. Puedes corregirla y pulsar ¬´Analizar¬ª.");
    stopListeningUI();
    analyzeNow();
  };

  r.onerror = () => {
    stopListeningUI();
    setStatus("‚ö†Ô∏è No se pudo usar el micr√≥fono. Escribe o pega tu texto y pulsa ¬´Analizar¬ª.");
  };

  r.onend = () => {
    if(isListening){
      stopListeningUI();
      setStatus("Fin de escucha. Si no sali√≥ texto, prueba otra vez o pega tu respuesta.");
    }
  };

  return r;
}

function speakQuestion(text){
  return new Promise((resolve) => {
    const synth = window.speechSynthesis;
    if(!synth){ resolve(); return; }

    function speakWithSpanishVoice(){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "es-ES";
      u.rate = 0.9;
      u.pitch = 1.0;

      // Try to force a Spanish voice (Spain preferred)
      const voices = synth.getVoices();
      const spanishVoice =
        voices.find(v => v.lang === "es-ES") ||
        voices.find(v => v.lang.startsWith("es")) ||
        null;

      if(spanishVoice){
        u.voice = spanishVoice;
      }

      u.onend = resolve;
      synth.speak(u);
    }

    // Voices may load asynchronously (Safari/iOS issue)
    if(synth.getVoices().length === 0){
      synth.onvoiceschanged = () => {
        speakWithSpanishVoice();
      };
    } else {
      speakWithSpanishVoice();
    }
  });
}

async function startFlow(){
  if(!currentKey) return;
  hideResults();

  const t = TOPICS[currentKey];
  if(!canRecognize()){
    setStatus("Este navegador no soporta reconocimiento de voz aqu√≠. Pega tu respuesta y analiza.");
    return;
  }

  setStatus("üîä Escucha la pregunta...");
  await speakQuestion(t.speak || t.title);

  if(!recognition) recognition = buildRecognition();

  setStatus("üé§ Habla ahora (45‚Äì90s)...");
  try{
    isListening = true;
    startListeningUI();
    recognition.start();
  }catch{
    stopListeningUI();
    setStatus("‚ö†Ô∏è No se pudo iniciar el micr√≥fono. Pega tu respuesta y analiza.");
  }
}

function stopListening(){
  if(recognition && isListening){
    try { recognition.stop(); } catch {}
  }
  stopListeningUI();
  setStatus("Escucha detenida. Puedes analizar lo que haya en la caja.");
}

function startListeningUI(){
  document.getElementById("btnStop").disabled = false;
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnStop").classList.add("listening");
}

function stopListeningUI(){
  isListening = false;
  document.getElementById("btnStop").disabled = true;
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnStop").classList.remove("listening");
}

/* =========================
   An√°lisis: normalizaci√≥n + matching
   ========================= */
function normalizeText(s){
  return (s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[‚Äú‚Äù"']/g," ")
    .replace(/[^a-z0-9√±\s]/g," ")
    .replace(/\s+/g," ")
    .trim();
}

function matchOne(pattern, textNorm){
  if(pattern instanceof RegExp){
    try { return pattern.test(textNorm); } catch { return false; }
  }
  const p = normalizeText(pattern);
  if(!p) return false;
  return textNorm.includes(p);
}

function evaluateCriteria(criteria, textRaw){
  const textNorm = normalizeText(textRaw);
  const results = criteria.map(c => {
    const ok = c.patterns.some(p => matchOne(p, textNorm));
    let status = "bad";
    if(ok) status = "ok";
    else status = c.required ? "bad" : "warn";

    let evidence = "";
    if(ok){
      const first = c.patterns.find(p => matchOne(p, textNorm));
      evidence = (first instanceof RegExp) ? "Detectado por patr√≥n" : `Detectado: ¬´${first}¬ª`;
    }
    return { ...c, status, evidence };
  });

  const required = results.filter(r => r.required);
  const requiredOK = required.filter(r => r.status === "ok").length;
  const requiredTotal = required.length;

  let overall = "bad";
  if(requiredOK === requiredTotal) overall = "ok";
  else if(requiredOK >= Math.max(1, Math.floor(requiredTotal * 0.6))) overall = "warn";

  return { results, overall, requiredOK, requiredTotal };
}

function analyzeNow(){
  if(!currentKey){
    setStatus("Elige un tema primero.");
    return;
  }
  const t = TOPICS[currentKey];
  const text = document.getElementById("transcript").value.trim();
  if(!text){
    setStatus("No hay respuesta. Habla o pega un texto y vuelve a analizar.");
    return;
  }

  const { results, overall, requiredOK, requiredTotal } = evaluateCriteria(t.criteria, text);

  const checklist = document.getElementById("checklist");
  checklist.style.display = "block";
  checklist.innerHTML = "";

  results.forEach(r => {
    const row = document.createElement("div");
    row.className = "item";
    const tag = r.status === "ok" ? "OK" : (r.status === "warn" ? "DUDOSO" : "FALTA");
    row.innerHTML = `
      <div style="flex:1;">
        <div><b>${r.label}</b> ${r.required ? '<span class="small">(obligatorio)</span>' : '<span class="small">(extra)</span>'}</div>
        <div class="evidence">
          ${r.status === "ok" ? (r.evidence || "Detectado") : r.hint}
        </div>
      </div>
      <div class="tag ${r.status}">${tag}</div>
    `;
    checklist.appendChild(row);
  });

  const summary = document.getElementById("summary");
  summary.style.display = "block";
  summary.className = overall;
  if(overall === "ok"){
    summary.innerHTML = `<b>¬°Muy bien!</b> Has cubierto todos los puntos obligatorios (${requiredOK}/${requiredTotal}).`;
  } else if(overall === "warn"){
    summary.innerHTML = `<b>Buen intento.</b> Has cubierto ${requiredOK}/${requiredTotal} puntos obligatorios. Repite a√±adiendo lo que falta.`;
  } else {
    summary.innerHTML = `<b>Te falta informaci√≥n clave.</b> Solo ${requiredOK}/${requiredTotal} puntos obligatorios. Usa las frases modelo y reintenta.`;
  }

  setStatus("An√°lisis completado.");
}

function hideResults(){
  document.getElementById("checklist").style.display = "none";
  document.getElementById("summary").style.display = "none";
}

function resetAll(){
  currentKey = null;
  document.getElementById("topicName").textContent = "‚Äî";
  document.getElementById("topicQuestionES").textContent = "‚Äî";
  document.getElementById("topicQuestionEN").textContent = "‚Äî";
  document.getElementById("transcript").value = "";
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnStop").disabled = true;
  document.getElementById("btnAnalyze").disabled = true;
  hideResults();
  setStatus("Esperando selecci√≥n...");
}

function setStatus(msg){
  document.getElementById("status").textContent = msg;
}

if(!canRecognize()){
  setStatus("Este navegador no soporta reconocimiento de voz aqu√≠. Puedes usarlo pegando tu respuesta y analizando.");
}
</script>
</body>
</html>
